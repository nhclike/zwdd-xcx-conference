import _regeneratorRuntime from"@babel/runtime/regenerator";import _asyncToGenerator from"@babel/runtime/helpers/asyncToGenerator";export var BRIDGE_ERROR_CODE;!function(e){e.CANCEL="-1",e.SUCCESS="0",e.API_UNDEFINED="1",e.INVALID_PARAMS="2",e.UNKNOWN_ERROR="3",e.UNAUTHORIZED_CALL="4",e.WRONG_CORP_ID="5",e.CREATE_CHAT_FAILED="6",e.UNAUTHORIZED_API="7",e.INVALID_CORP_ID="8",e.SERVER_RESPONSE_ERROR="9",e.WRONG_DEVICE_INFO="10",e.UPLOAD_FAIL="11",e.PROCESS_FAIL="12",e.DUPLICATED_CALL="13",e.TOO_LARGE_PIC="14",e.REQUEST_REJECT_OR_INSECURE_REQUEST="15",e.PC_NOT_ALLOWED_TO_OPEN_SIDE_PANE_OR_MODAL="21",e.PC_CLOSE_SIDE_PANE_OR_MODAL="22",e.UNAUTHORIZED_PARAMS="23",e.GESTURE_PASSWORD_DOES_NOT_EXIST="24",e.NETWORK_ERROR="25"}(BRIDGE_ERROR_CODE||(BRIDGE_ERROR_CODE={}));export var API_INVOKER_TYPE;!function(e){e.MOBILE="mobile",e.PC="pc",e.MINI_APP="mini",e.UNKNOWN="unknown"}(API_INVOKER_TYPE||(API_INVOKER_TYPE={}));export var CONTINUOUS_EVENT_LIST;!function(e){e.UPDATE_NETWORK_STATUS="DINGGOV_ON_NETWORK_TYPE_CHANGED",e.UPDATE_LOCATION="DINGGOV_GEO_LOCATION_UPDATE",e.UPDATE_TRACE="DINGGOV_TRACE_UPDATE",e.ON_SHAKE="onShake"}(CONTINUOUS_EVENT_LIST||(CONTINUOUS_EVENT_LIST={}));var Invoker=function(){function e(){this.currentInvoker=void 0,this.readyFnStack=[],this.callbackStack={},this.generalEventCallbackStack={},this.apiList={},this.continuousCallbackStack={},this.isH5Mobile=null,this.appType=null,this.aliBridge=window&&window.navigator&&window.AlipayJSBridge,this.isReady=!1,this.init()}var t=e.prototype;return t.init=function(){var e=this,t=this.getAppType();t===API_INVOKER_TYPE.PC&&window.dingtalk&&window.dingtalk.event.register((function(t,n){var i=""+n.msgId;"openapi.event.emit"===t?(console.log("dingtalk receive event:",n,"identifer is",i),e.callbackStack[i]&&(e.callbackStack[i](n),delete e.callbackStack[i])):"im.fileTask.addNewTask"===t||"im.fileTask.updateTask"===t?e.continuousCallbackStack[n.msgId||n.taskId](t,n):e.generalEventCallbackStack[t]&&e.generalEventCallbackStack[t].forEach((function(t){t.call(e,n)}))})),t===API_INVOKER_TYPE.MOBILE?window.AlipayJSBridge?this.execReadyFn():document.addEventListener("AlipayJSBridgeReady",(function(){e.execReadyFn.call(e)}),!1):setTimeout((function(){e.execReadyFn()}))},t.execReadyFn=function(){this.isReady=!0;for(var e=this.readyFnStack.shift();e;)e&&e(this),e=this.readyFnStack.shift()},t.onReady=function(e){this.isReady?e&&e(this):this.readyFnStack.push(e)},t.setCurrentInvoker=function(e){this.currentInvoker=e},t.getCurrentInvoker=function(){return this.currentInvoker},t.getBridge=function(){return this.aliBridge},t.getAppType=function(){return this.appType||(this.isMobile()?this.appType=API_INVOKER_TYPE.MOBILE:window&&window.navigator&&window.navigator.userAgent&&window.navigator.userAgent.indexOf("dingtalk-win")>=0?this.appType=API_INVOKER_TYPE.PC:!window&&my&&my.call?this.appType=API_INVOKER_TYPE.MINI_APP:(console.warn("检测到页面在非政务钉钉客户端中打开，JSAPI 调用可能不会生效！"),this.appType=API_INVOKER_TYPE.UNKNOWN)),this.appType},t.isMobile=function(){if(null!==this.isH5Mobile)return this.isH5Mobile;var e=window&&window.navigator&&window.navigator.userAgent||"";return e&&e.indexOf("dingtalk-win")>=0?(this.isH5Mobile=!1,!1):!!(e&&e.indexOf("mPaaSClient")>=0)&&(this.isH5Mobile=!0,!0)},t.registerEvent=function(e,t){var n=this;if("function"==typeof t)return this.getAppType()===API_INVOKER_TYPE.PC?(this.generalEventCallbackStack[e]||(this.generalEventCallbackStack[e]=[]),this.generalEventCallbackStack[e].push(t),function(){var i=n.generalEventCallbackStack[e].findIndex((function(e){return e===t}));n.generalEventCallbackStack[e].splice(i,1)}):this.getAppType()===API_INVOKER_TYPE.MOBILE?(document.addEventListener(e,t,!1),function(){document.removeEventListener(e,t)}):void 0;console.error("callback 参数应该为函数")},t.registerClientAPI=function(e,t){this.apiList[e]=t},t.registerAPI=function(e,t){this.isMobile();if("object"==typeof t){var n=t,i=this.getAppType();this.registerClientAPI(e,n[i])}else this.registerClientAPI(e,t)},t.invokeMiniApp=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n){var i=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={}),e.abrupt("return",new Promise((function(e,r){var a=i.apiList[t];if(!a)return console.warn("API: "+t+"，未注册"),r("API: "+t+"，未注册");"function"!=typeof a?my.call(t,n,(function(t){i.handleBridgeResponse(t,e,r)})):a.call(null,n,{context:my,resolve:e,reject:r,methodName:t})})));case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),t.invokeMobile=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n){var i=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={}),e.abrupt("return",new Promise((function(e,r){var a=i.apiList[t];if(!a)return console.warn("API: "+t+"，未注册"),r("API: "+t+"，未注册");"function"!=typeof a?AlipayJSBridge.call(t,n,(function(t){i.handleBridgeResponse(t,e,r)})):a.call(null,n,{context:AlipayJSBridge,resolve:e,reject:r,methodName:t})})));case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),t.findFitMsgId=function(e){return this.callbackStack[e]?this.findFitMsgId(e+1):e},t.invokePC=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n,i){var r=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={}),void 0===i&&(i={msgId:1}),e.abrupt("return",new Promise((function(e,a){try{var o=r.findFitMsgId(Date.now()),s=i.pcClientAPIName||t;if(i.msgId=o,!window.dingtalk)return Promise.reject(new Error("请在钉钉容器内使用 JSAPI"));r.apiList[t]?r.apiList[t].call(null,n,i):(console.info("invoke bridge api:",s,o,n),window.dingtalk.platform.invokeAPI(o,s,n)),r.callbackStack[""+o]=function(t){var n=t;return n.body?e(n.body):e(n)}}catch(e){a(e)}})));case 3:case"end":return e.stop()}}),e)})));return function(t,n,i){return e.apply(this,arguments)}}(),t.handleBridgeResponse=function(e,t,n){e&&e.errorCode?e.errorCode===BRIDGE_ERROR_CODE.SUCCESS?t(e.result):(console.warn("API 调用失败",e),n(e)):e&&"false"===e.success?n(e):t(e)},t.invoke=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(t,n,i){var r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n={}),(r=this.getAppType())!==API_INVOKER_TYPE.MOBILE){e.next=8;break}if(this.isReady){e.next=5;break}return e.abrupt("return",Promise.reject("错误：请在 dd.ready() 回调中使用 JSAPI，当前调用函数："+t));case 5:return e.abrupt("return",this.invokeMobile(t,n));case 8:if(r!==API_INVOKER_TYPE.PC){e.next=12;break}return e.abrupt("return",this.invokePC(t,n,i));case 12:if(r!==API_INVOKER_TYPE.MINI_APP){e.next=16;break}return e.abrupt("return",this.invokeMiniApp(t,n));case 16:return e.abrupt("return",Promise.reject("错误：未在钉钉运行环境下调用该 API，无效，请检查运行环境"));case 17:case"end":return e.stop()}}),e,this)})));return function(t,n,i){return e.apply(this,arguments)}}(),t.existEventListener=function(e){return!!this.continuousCallbackStack[e]},t.registerContinuesEvent=function(e,t){this.continuousCallbackStack[e]=t},t.removeContinuesEvent=function(e){this.existEventListener(e)&&(this.continuousCallbackStack[e](),delete this.continuousCallbackStack[e])},e}();export default new Invoker;