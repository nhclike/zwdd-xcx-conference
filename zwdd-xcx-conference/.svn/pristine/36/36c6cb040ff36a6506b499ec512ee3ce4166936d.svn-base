import _extends from"@babel/runtime/helpers/extends";var systemInfo,H5_PAGE="h5Page",MEETING_DETAIL="meetingDetail",targetPageArr=[H5_PAGE,MEETING_DETAIL],isMiniProgram=!window&&my&&my.call,userAgent=null,screenWidth=null,containerComp=null;isMiniProgram&&(systemInfo=my.getSystemInfoSync()),userAgent=isMiniProgram?systemInfo.platform:navigator.userAgent,screenWidth=isMiniProgram?systemInfo.screenWidth:window.screen.width;var WaterMark=function(){function t(t){void 0===t&&(t={}),this.options=_extends({texts:[""],width:50,height:50,textRotate:-10,textColor:"#000000",textFont:"PingFangSC-Regular,system-ui,sans-serif",fontStyle:"normal",opacity:90,canvas:[],fontSize:14},t)}var e=t.prototype;return e.init=function(){var t=this,e=null,n=null;isMiniProgram?n=my.createCanvasContext("canvasBg"):(e=this.createCanvas(),n=e.getContext("2d"));var i=this.options;i.deg=i.textRotate*Math.PI/180,this.calcTextSize();var a=Math.ceil(screenWidth/i.txts.length/i.width);i.canvasWidth*=a;for(var r=[];a;)a-=1,r=r.concat(i.txts);i.txts=r;var o=i.maxWidth*Math.abs(Math.sin(i.deg))+Math.cos(i.deg)*i.textHeight;o>i.height&&(i.height=o);var s=function(){t.setCanvasStyle(e,n,i.canvasWidth,2*i.height),t.drawText(n,i.txts),n.translate(0,i.height),t.drawText(n,i.txts.reverse(),!0)};if(isMiniProgram)return new Promise((function(t){containerComp.setState({width:i.canvasWidth,height:2*i.height},(function(){setTimeout((function(){s(),n.draw(),t(n.toDataURL("image/png"))}),0)}))}));s();var h=e.toDataURL("image/png");return this.destroy(),h},e.createCanvas=function(){var t=document.createElement("canvas");return this.options.canvas.push(t),t},e.calcTextSize=function(){var t=this,e=[],n=0,i=0,a=this.options;a.texts.forEach((function(r){var o,s;if(isMiniProgram){for(var h=0,g=0;g<r.length;g+=1)h+=/[\uff00-\uffff]/.test(r[g])?1:.5;o=1.1*a.fontSize*h,s=1.2*a.fontSize}else{var c=t.createElementFromHTML('<span style="font:'+a.fontSize+"px "+a.textFont+';visibility: hidden;">'+r+"</span>");document.body.appendChild(c),o=c.offsetWidth,s=c.offsetHeight,document.body.removeChild(c)}e.push({txt:r,width:o,height:s}),n=Math.max(n,o),a.textHeight=s;var l=Math.cos(a.deg)*o;i+=(a.width<l?l:a.width)-s*Math.sin(a.deg)})),a.txts=e,a.maxWidth=n,a.canvasWidth=i},e.createElementFromHTML=function(t){var e=document.createElement("div");return e.innerHTML=t.trim(),e.firstChild},e.setCanvasStyle=function(t,e,n,i){isMiniProgram||(t.width=n,t.height=i,t.style.display="none");var a=this.options.deg,r=Math.abs(Math.sin(a));e.rotate(a);var o=r*this.options.height-this.options.textHeight*r,s=-o*Math.cos(a),h=-o*r;e.translate(s,h),e.font=this.options.fontStyle+" "+this.options.fontSize+"px "+this.options.textFont,e.fillStyle=this.options.textColor,e.textAlign="left",e.textBaseline="Middle",e.globalAlpha=this.options.opacity},e.drawText=function(t,e,n){void 0===n&&(n=!1);var i=this.options;e.forEach((function(e,a){var r=(i.maxWidth-e.width)/2,o=i.width*Math.cos(i.deg)*a,s=-o*Math.tan(i.deg)+i.height;t.fillText(e.txt,o+r+(n?i.maxWidth/2:0),s)}))},e.destroy=function(){this.options.canvas.forEach((function(t){t.remove(),t=null}))},t}();function drawWatermark(t,e){var n=JSON.parse(t),i=n.watermark||n;if(!i||"0"===String(i.watermarkStatus))return"";if(!Array.isArray(i.targetPages)||!i.targetPages.find((function(t){return n=t,e?n.name===e&&"1"===String(n.value):n.name===H5_PAGE&&"1"===String(n.value);var n})))return"";var a,r,o=[];if(Array.isArray(i.contentType)){var s="";i.contentType.includes(1)&&(s+=i.userName+" "),i.contentType.includes(2)&&(s+=(i.account||"").slice(-4)),s&&o.push(s),i.contentType.includes(0)&&i.contentCustom&&o.push(i.contentCustom)}if(!o.length)return"";var h=userAgent.indexOf("Android")>-1||userAgent.indexOf("Linux")>-1;if(!!userAgent.match(/iPhone|iOS|(\(i[^;]+;( U;)? CPU.+Mac OS X)/))"0"===String(i.watermarkShowDensity)?(a=114,r=66):(a=86,r=45);else if(h){var g=(isMiniProgram?systemInfo&&systemInfo.pixelRatio:window&&window.devicePixelRatio)||2;"0"===String(i.watermarkShowDensity)?(a=47*g,r=40*g):(a=25*g,r=25*g)}else"0"===String(i.watermarkShowDensity)?(a=300,r=126):(a=194,r=106);var c=new WaterMark({texts:o,width:a,height:r,textRotate:-10,textColor:"1"===String(i.fontColor)?"#000000":"2"===String(i.fontColor)?"#0000FF":"#FF0000",textFont:"PingFangSC-Regular,system-ui,sans-serif",fontStyle:"0"===String(i.fontStyle)?"normal":"bold",opacity:(120-parseInt(i.fontDiaphaneity,10))/100,fontSize:"0"===String(i.fontSize)?12:"1"===String(i.fontSize)?16:28});return c.options.width=c.options.width*c.options.fontSize/12,c.options.height=c.options.height*c.options.fontSize/12,c.init()}export function generateWatermark(t,e){void 0===t&&(t={}),isMiniProgram&&(containerComp=this),e&&!targetPageArr.includes(e)&&(console.error("可选参数onlyThePage，仅能为“h5Page”或“meetingDetail”"),e=H5_PAGE);try{return drawWatermark(JSON.stringify(t),e)}catch(t){console.error(t)}}