"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=!0,exports.generateWatermark=generateWatermark;var systemInfo,_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),H5_PAGE="h5Page",MEETING_DETAIL="meetingDetail",targetPageArr=[H5_PAGE,MEETING_DETAIL],isMiniProgram=!window&&my&&my.call,userAgent=null,screenWidth=null,containerComp=null;isMiniProgram&&(systemInfo=my.getSystemInfoSync()),userAgent=isMiniProgram?systemInfo.platform:navigator.userAgent,screenWidth=isMiniProgram?systemInfo.screenWidth:window.screen.width;var WaterMark=function(){function t(t){void 0===t&&(t={}),this.options=(0,_extends2.default)({texts:[""],width:50,height:50,textRotate:-10,textColor:"#000000",textFont:"PingFangSC-Regular,system-ui,sans-serif",fontStyle:"normal",opacity:90,canvas:[],fontSize:14},t)}var e=t.prototype;return e.init=function(){var t=this,e=null,i=null;isMiniProgram?i=my.createCanvasContext("canvasBg"):(e=this.createCanvas(),i=e.getContext("2d"));var n=this.options;n.deg=n.textRotate*Math.PI/180,this.calcTextSize();var r=Math.ceil(screenWidth/n.txts.length/n.width);n.canvasWidth*=r;for(var a=[];r;)r-=1,a=a.concat(n.txts);n.txts=a;var o=n.maxWidth*Math.abs(Math.sin(n.deg))+Math.cos(n.deg)*n.textHeight;o>n.height&&(n.height=o);var s=function(){t.setCanvasStyle(e,i,n.canvasWidth,2*n.height),t.drawText(i,n.txts),i.translate(0,n.height),t.drawText(i,n.txts.reverse(),!0)};if(isMiniProgram)return new Promise((function(t){containerComp.setState({width:n.canvasWidth,height:2*n.height},(function(){setTimeout((function(){s(),i.draw(),t(i.toDataURL("image/png"))}),0)}))}));s();var h=e.toDataURL("image/png");return this.destroy(),h},e.createCanvas=function(){var t=document.createElement("canvas");return this.options.canvas.push(t),t},e.calcTextSize=function(){var t=this,e=[],i=0,n=0,r=this.options;r.texts.forEach((function(a){var o,s;if(isMiniProgram){for(var h=0,g=0;g<a.length;g+=1)h+=/[\uff00-\uffff]/.test(a[g])?1:.5;o=1.1*r.fontSize*h,s=1.2*r.fontSize}else{var l=t.createElementFromHTML('<span style="font:'+r.fontSize+"px "+r.textFont+';visibility: hidden;">'+a+"</span>");document.body.appendChild(l),o=l.offsetWidth,s=l.offsetHeight,document.body.removeChild(l)}e.push({txt:a,width:o,height:s}),i=Math.max(i,o),r.textHeight=s;var c=Math.cos(r.deg)*o;n+=(r.width<c?c:r.width)-s*Math.sin(r.deg)})),r.txts=e,r.maxWidth=i,r.canvasWidth=n},e.createElementFromHTML=function(t){var e=document.createElement("div");return e.innerHTML=t.trim(),e.firstChild},e.setCanvasStyle=function(t,e,i,n){isMiniProgram||(t.width=i,t.height=n,t.style.display="none");var r=this.options.deg,a=Math.abs(Math.sin(r));e.rotate(r);var o=a*this.options.height-this.options.textHeight*a,s=-o*Math.cos(r),h=-o*a;e.translate(s,h),e.font=this.options.fontStyle+" "+this.options.fontSize+"px "+this.options.textFont,e.fillStyle=this.options.textColor,e.textAlign="left",e.textBaseline="Middle",e.globalAlpha=this.options.opacity},e.drawText=function(t,e,i){void 0===i&&(i=!1);var n=this.options;e.forEach((function(e,r){var a=(n.maxWidth-e.width)/2,o=n.width*Math.cos(n.deg)*r,s=-o*Math.tan(n.deg)+n.height;t.fillText(e.txt,o+a+(i?n.maxWidth/2:0),s)}))},e.destroy=function(){this.options.canvas.forEach((function(t){t.remove(),t=null}))},t}();function drawWatermark(t,e){var i=JSON.parse(t),n=i.watermark||i;if(!n||"0"===String(n.watermarkStatus))return"";if(!Array.isArray(n.targetPages)||!n.targetPages.find((function(t){return i=t,e?i.name===e&&"1"===String(i.value):i.name===H5_PAGE&&"1"===String(i.value);var i})))return"";var r,a,o=[];if(Array.isArray(n.contentType)){var s="";n.contentType.includes(1)&&(s+=n.userName+" "),n.contentType.includes(2)&&(s+=(n.account||"").slice(-4)),s&&o.push(s),n.contentType.includes(0)&&n.contentCustom&&o.push(n.contentCustom)}if(!o.length)return"";var h=userAgent.indexOf("Android")>-1||userAgent.indexOf("Linux")>-1;if(!!userAgent.match(/iPhone|iOS|(\(i[^;]+;( U;)? CPU.+Mac OS X)/))"0"===String(n.watermarkShowDensity)?(r=114,a=66):(r=86,a=45);else if(h){var g=(isMiniProgram?systemInfo&&systemInfo.pixelRatio:window&&window.devicePixelRatio)||2;"0"===String(n.watermarkShowDensity)?(r=47*g,a=40*g):(r=25*g,a=25*g)}else"0"===String(n.watermarkShowDensity)?(r=300,a=126):(r=194,a=106);var l=new WaterMark({texts:o,width:r,height:a,textRotate:-10,textColor:"1"===String(n.fontColor)?"#000000":"2"===String(n.fontColor)?"#0000FF":"#FF0000",textFont:"PingFangSC-Regular,system-ui,sans-serif",fontStyle:"0"===String(n.fontStyle)?"normal":"bold",opacity:(120-parseInt(n.fontDiaphaneity,10))/100,fontSize:"0"===String(n.fontSize)?12:"1"===String(n.fontSize)?16:28});return l.options.width=l.options.width*l.options.fontSize/12,l.options.height=l.options.height*l.options.fontSize/12,l.init()}function generateWatermark(t,e){void 0===t&&(t={}),isMiniProgram&&(containerComp=this),e&&!targetPageArr.includes(e)&&(console.error("可选参数onlyThePage，仅能为“h5Page”或“meetingDetail”"),e=H5_PAGE);try{return drawWatermark(JSON.stringify(t),e)}catch(t){console.error(t)}}